{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.31.92.45157",
      "templateHash": "17656228496942359420"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location of all resources deployed by this template."
      }
    },
    "nameConvResTypeAtEnd": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Reverse the order of the resource type and name in the generated resource name. Default is false."
      }
    },
    "functionAppName": {
      "type": "string",
      "metadata": {
        "description": "Required. The name of the function App."
      }
    },
    "functionAppResourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Required. The name of the resource group where the function App will be deployed."
      }
    },
    "functionAppKind": {
      "type": "string",
      "defaultValue": "functionapp,linux",
      "allowedValues": [
        "functionapp",
        "functionapp,linux"
      ],
      "metadata": {
        "description": "Optional. The type of site to deploy"
      }
    },
    "runtimeStack": {
      "type": "string",
      "defaultValue": "dotnet",
      "allowedValues": [
        "dotnet",
        "java",
        "node",
        "powershell",
        "python"
      ],
      "metadata": {
        "description": "Optional. The runtime stack used by the function App."
      }
    },
    "runtimeVersion": {
      "type": "string",
      "defaultValue": ".NET 8 Isolated",
      "metadata": {
        "description": "Optional. The version of the runtime stack used by the function App. The version must be compatible with the runtime stack."
      }
    },
    "flexConsumptionInstanceMemoryMB": {
      "type": "int",
      "defaultValue": 2048,
      "allowedValues": [
        2048,
        4096
      ],
      "metadata": {
        "description": "Optional. Determines the memory size of the instances on which your app runs in the FlexConsumption hosting plan."
      }
    },
    "flexConsumptionMaximumInstanceCount": {
      "type": "int",
      "defaultValue": 100,
      "minValue": 40,
      "maxValue": 1000,
      "metadata": {
        "description": "Optional. The maximum number of instances that the function App can scale out to in the FlexConsumption hosting plan."
      }
    },
    "deployHostingPlan": {
      "type": "bool",
      "metadata": {
        "description": "Required. Determines whether or not a new host plan is deployed. If set to false then the \"hostingPlanId\" parameter must be provided."
      }
    },
    "hostingPlanType": {
      "type": "string",
      "defaultValue": "Consumption",
      "allowedValues": [
        "Consumption",
        "FlexConsumption",
        "FunctionsPremium",
        "AppServicePlan"
      ],
      "metadata": {
        "description": "Conditional. When you create a function app in Azure, you must choose a hosting plan for your app.\nThere are four basic Azure Functions hosting plans provided by Azure Functions: Consumption plan, Flex Consumption, Premium plan, and Dedicated (App Service) plan. \n* Consumption: Scale automatically and only pay for compute resources when your functions are running.\n* FlexConsumption: Flex Consumption is a Linux-based Azure Functions hosting plan that builds on the Consumption pay for what you use serverless billing model. It gives you more flexibility and customizability by introducing private networking, instance memory size selection, and fast/large scale-out features still based on a serverless model.\n* FunctionsPremium: Automatically scales based on demand using pre-warmed workers, which run applications with no delay after being idle, runs on more powerful instances, and connects to virtual networks.\n* AppServicePlan: Best for long-running scenarios where Durable Functions can't be used. Consider an App Service plan in the following situations:\n  * You have existing, underutilized VMs that are already running other App Service instances.\n  * Predictive scaling and costs are required.\n"
      }
    },
    "hostingPlanId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The resource Id of the existing server farm to use for the function App. Required when \"deployHostingPlan\" is set to false."
      }
    },
    "hostingPlanName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The name of the service plan used by the function App. Required when \"deployHostingPlan\" is set to true."
      }
    },
    "hostingPlanResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The name of the resource Group where the hosting plan will be deployed. Required when \"deployHostingPlan\" is set to true."
      }
    },
    "hostingPlanPricing": {
      "type": "string",
      "defaultValue": "Dynamic_Y1",
      "allowedValues": [
        "Dynamic_Y1",
        "ElasticPremium_EP1",
        "ElasticPremium_EP2",
        "ElasticPremium_EP3",
        "FlexConsumption_FC1",
        "Free_F1",
        "Basic_B1",
        "Basic_B2",
        "Basic_B3",
        "PremiumV3_P0V3",
        "PremiumV3_P1V3",
        "PremiumV3_P1mv3",
        "PremiumV3_P2V3",
        "PremiumV3_P2mv3",
        "PremiumV3_P3V3",
        "PremiumV3_P3mv3",
        "PremiumV3_P4mv3",
        "PremiumV3_P5mv3",
        "Shared_D1"
      ],
      "metadata": {
        "description": "Conditional. The hosting plan pricing plan. Required when \"deployHostingPlan\" is set to true and hostingPlanType is not set to \"Consumption\"."
      }
    },
    "hostingPlanZoneRedundant": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Determines if the hosting plan is zone redundant. Not used when \"hostingPlanId\" is provided or hostingPlanType is set to \"Consumption\"."
      }
    },
    "deployStorageAccount": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Determines whether an existing storage account is used or a new one is deployed. If set to true, the \"storageAccountName\" parameter must be provided. If set to false, the \"storageAccountId\" parameter must be provided."
      }
    },
    "storageAccountId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The resource Id of the existing storage account to be used with the logic app. Required when \"deployStorageAccount\" is set to false."
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The name of the storage account used by the function App. Required if \"deployStorageAccount\" is set to true."
      }
    },
    "addAzureFilesConnection": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. For Function Apps using the Consumption or FunctionsPremium hosting plans, determines whether the function App should be connected to the storage account through an Azure Files share."
      }
    },
    "enableApplicationInsights": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable Application Insights for the function App."
      }
    },
    "privateLinkScopeResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Associate the applications insights with an Azure Monitor Private Link Scope. Used only when enableApplicationInsights is set to true."
      }
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. To enable diagnostics settings, provide the resource Id of the Log Analytics workspace where logs are to be sent."
      }
    },
    "enablePublicAccess": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Indicates whether the function App should be accessible from the public network."
      }
    },
    "ipSecurityRestrictions": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. The network rules that are applied to inbound access for the function App."
      }
    },
    "ipSecurityRestrictionsDefaultAction": {
      "type": "string",
      "defaultValue": "Allow",
      "allowedValues": [
        "Allow",
        "Deny"
      ],
      "metadata": {
        "description": "Optional. Indicates what the default action is when an IP restriction rule is not matched."
      }
    },
    "scmIpSecurityRestrictions": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. The network rules that are applied to inbound access for the advanced (scm) website of the function app."
      }
    },
    "scmIpSecurityRestrictionsDefaultAction": {
      "type": "string",
      "defaultValue": "Allow",
      "allowedValues": [
        "Allow",
        "Deny"
      ],
      "metadata": {
        "description": "Optional. Indicates what the default action is when an IP restriction rule is not matched."
      }
    },
    "scmIpSecurityRestrictionsUseMain": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Determines whether the IP security restrictions for the scm site are the same as the main site."
      }
    },
    "enableInboundPrivateEndpoint": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Indicates whether the function App should be accessible via a private endpoint."
      }
    },
    "enableVnetIntegration": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Indicates whether outbound traffic from the function App should be routed over a vnet."
      }
    },
    "deployNetworking": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Indicates whether a new Vnet and associated resources should be deployed to support the hosting plan and function app."
      }
    },
    "deployFunctionAppPrivateDnsZone": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Indicates whether private DNS zones should be created for the function App."
      }
    },
    "deployStoragePrivateDnsZones": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Indicates whether private DNS zones should be created for the storage account."
      }
    },
    "functionAppInboundSubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The resource Id of the subnet used by the function App for inbound traffic. Required when \"enableInboundPrivateEndpoint\" is set to true and \"deployNetworking\" is set to false."
      }
    },
    "functionAppOutboundSubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The resource Id of the subnet used by the function App for outbound traffic. Required when \"enableVnetIntegration\" is set to true and \"deployNetworking\" is set to false."
      }
    },
    "storagePrivateEndpointSubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional The resource Id of the private Endpoint Subnet. Required when \"enableStoragePrivateEndpoints\" is set to true and \"deployNetworking\" is set to false."
      }
    },
    "vnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The name of the virtual network used for Virtual Network Integration. Required when \"enableVnetIntegration\" is set to true and \"deployNetworking\" = true."
      }
    },
    "networkingResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Conditional. The name of the resource group where the virtual network is deployed. Required when \"enableVnetIntegration\" is set to true and \"deployNetworking\" = true."
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "Optional. The address prefix of the virtual network used Virtual Network Integration."
      }
    },
    "functionAppOutboundSubnetName": {
      "type": "string",
      "defaultValue": "fa-outbound-subnet",
      "metadata": {
        "description": "Optional. The name of the subnet used by the function App for Virtual Network Integration. Used when \"enableVnetIntegration\" is set to true and \"deployNetworking\" = true."
      }
    },
    "functionAppOutboundSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/24",
      "metadata": {
        "description": "Optional. The address prefix of the subnet used by the function App for Virtual Network Integration. Used when \"enableVnetIntegration\" is set to true and \"deployNetworking\" = true."
      }
    },
    "enableStoragePrivateEndpoints": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Determines whether private endpoints are used on the function app storage account. Used when \"enableVnetIntegration\" is set to true."
      }
    },
    "storagePrivateEndpointSubnetName": {
      "type": "string",
      "defaultValue": "storage-subnet",
      "metadata": {
        "description": "Optional. The name of the subnet used for private Endpoints. Used when \"enableVnetIntegration\", \"enableStoragePrivateEndpoints\", and \"deployNetworking\" are all set to  \"true\"."
      }
    },
    "storagePrivateEndpointSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.1.0/24",
      "metadata": {
        "description": "Optional. The address prefix of the subnet used for private Endpoints. Used when \"enableVnetIntegration\", \"enableStoragePrivateEndpoints\", and \"deployNetworking\" are all set to  \"true\"."
      }
    },
    "functionAppInboundSubnetName": {
      "type": "string",
      "defaultValue": "fa-inbound-subnet",
      "metadata": {
        "description": "Optional. The name of the subnet used by the function App for inbound access when public access is disabled. Used when \"enableInboundPrivateEndpoint\" and \"deployNetworking\" = true."
      }
    },
    "functionAppInboundSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.2.0/24",
      "metadata": {
        "description": "Optional. The address prefix of the subnet used by the function App for inbound access when public access is disabled. Used when \"enableInboundPrivateEndpoint\" and \"deployNetworking\" = true."
      }
    },
    "functionAppPrivateDnsZoneId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource Id of the function app private DNS Zone. Required when \"enableInboundPrivateEndpoint\" = true and \"deployNetworking\" = false."
      }
    },
    "storageBlobDnsZoneId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource Id of the blob storage Private DNS Zone. Required when \"enableVnetIntegration\" and \"enableStoragePrivateEndpoints\" = true and \"deployNetworking = false."
      }
    },
    "storageFileDnsZoneId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource Id of the file storage Private DNS Zone. Required when \"enableVnetIntegration\" and \"enableStoragePrivateEndpoints\" = true and \"deployNetworking = false."
      }
    },
    "storageQueueDnsZoneId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource Id of the queue storage Private DNS Zone. Required when \"enableVnetIntegration\" and \"enableStoragePrivateEndpoints\" = true and \"deployNetworking = false."
      }
    },
    "storageTableDnsZoneId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The resource Id of the table storage Private DNS Zone. Required when \"enableVnetIntegration\" and \"enableStoragePrivateEndpoints\" = true and \"deployNetworking = false."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. The tags to be assigned to the resources deployed by this template.\nMust be provided in the following 'TagsByResource' format: (JSON)\n{\n  \"Microsoft.Storage/storageAccounts\": {\n    \"key1\": \"value1\",\n    \"key2\": \"value2\"\n  },\n  \"Microsoft.Web/sites\": {\n    \"key1\": \"value1\",\n    \"key2\": \"value2\"\n  },\n  \"Microsoft.Web/serverfarms\": {\n    \"key1\": \"value1\",\n    \"key2\": \"value2\"\n  },\n  {\n    \"Microsoft.Network/privateEndpoints\" : {\n      \"key1\": \"value1\",\n      \"key2\": \"value2\"\n    }\n  },\n  {\n    \"Microsoft.Network/virtualNetworks\" : {\n      \"key1\": \"value1\",\n      \"key2\": \"value2\"\n    }\n  }\n}\n"
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "automationAccounts": "aa",
      "availabilitySets": "as",
      "computeGalleries": "gal",
      "dataCollectionEndpoints": "dce",
      "dataCollectionRules": "dcr",
      "desktopApplicationGroups": "vddag",
      "diskAccesses": "da",
      "remoteApplicationGroups": "vdrag",
      "disks": "disk",
      "diskEncryptionSets": "des",
      "hostPools": "vdpool",
      "keyVaults": "kv",
      "logAnalyticsWorkspaces": "law",
      "natGateways": "ng",
      "netAppAccounts": "naa",
      "netAppCapacityPools": "nacp",
      "networkInterfaces": "nic",
      "privateEndpoints": "pe",
      "recoveryServicesVaults": "rsv",
      "resourceGroups": "rg",
      "storageAccounts": "sa",
      "subnets": "subnet",
      "userAssignedIdentities": "uai",
      "virtualMachines": "vm",
      "virtualNetworks": "vnet",
      "workspaces": "vdws"
    },
    "cloudSuffix": "[replace(replace(environment().resourceManager, 'https://management.', ''), '/', '')]",
    "privateDnsZoneSuffixes_AzureWebSites": {
      "AzureCloud": "azurewebsites.net",
      "AzureUSGovernment": "azurewebsites.us",
      "USNat": null,
      "USSec": null
    },
    "webSitePrivateDnsZoneName": "[if(parameters('enableInboundPrivateEndpoint'), createArray(format('privatelink.{0}', coalesce(variables('privateDnsZoneSuffixes_AzureWebSites')[environment().name], format('appservice.{0}', variables('cloudSuffix'))))), createArray())]",
    "resourceAbbreviations": "[variables('$fxv#0')]",
    "privateEndpointNameConv": "[replace(if(parameters('nameConvResTypeAtEnd'), 'RESOURCENAME-SERVICE-VNET-RESOURCETYPE', 'RESOURCETYPE-RESOURCENAME-SERVICE-VNET'), 'RESOURCETYPE', variables('resourceAbbreviations').privateEndpoints)]",
    "privateEndpointNICNameConvTemp": "[if(parameters('nameConvResTypeAtEnd'), format('{0}-RESOURCETYPE', variables('privateEndpointNameConv')), format('RESOURCETYPE-{0}', variables('privateEndpointNameConv')))]",
    "privateEndpointNICNameConv": "[replace(variables('privateEndpointNICNameConvTemp'), 'RESOURCETYPE', variables('resourceAbbreviations').networkInterfaces)]",
    "subnetOutbound": "[if(parameters('enableVnetIntegration'), createArray(createObject('name', parameters('functionAppOutboundSubnetName'), 'properties', createObject('delegations', createArray(createObject('name', if(equals(parameters('hostingPlanType'), 'FlexConsumption'), 'appEnvironments', 'webServerFarms'), 'properties', createObject('serviceName', if(equals(parameters('hostingPlanType'), 'FlexConsumption'), 'Microsoft.App/environments', 'Microsoft.Web/serverFarms')))), 'addressPrefix', parameters('functionAppOutboundSubnetAddressPrefix')))), createArray())]",
    "subnetStoragePrivateEndpoints": "[if(parameters('enableStoragePrivateEndpoints'), createArray(createObject('name', parameters('storagePrivateEndpointSubnetName'), 'properties', createObject('privateEndpointNetworkPolicies', 'Disabled', 'addressPrefix', parameters('storagePrivateEndpointSubnetAddressPrefix')))), createArray())]",
    "subnetInboundPrivateEndpoint": "[if(parameters('enableInboundPrivateEndpoint'), createArray(createObject('name', parameters('functionAppInboundSubnetName'), 'properties', createObject('privateEndpointNetworkPolicies', 'Disabled', 'addressPrefix', parameters('functionAppInboundSubnetAddressPrefix')))), createArray())]",
    "storagePrivateDnsZoneNames": "[if(parameters('enableStoragePrivateEndpoints'), createArray(format('privatelink.blob.{0}', environment().suffixes.storage), format('privatelink.file.{0}', environment().suffixes.storage), format('privatelink.queue.{0}', environment().suffixes.storage), format('privatelink.table.{0}', environment().suffixes.storage)), createArray())]",
    "resourceGroupNameFunctionApp": "[parameters('functionAppResourceGroupName')]",
    "resourceGroupNameStorage": "[if(and(not(empty(parameters('storageAccountId'))), not(parameters('deployStorageAccount'))), split(parameters('storageAccountId'), '/')[4], variables('resourceGroupNameFunctionApp'))]",
    "resourceGroupNameHostingPlan": "[if(not(empty(parameters('hostingPlanResourceGroupName'))), parameters('hostingPlanResourceGroupName'), variables('resourceGroupNameFunctionApp'))]",
    "resourceGroupNameNetworking": "[if(not(empty(parameters('networkingResourceGroupName'))), parameters('networkingResourceGroupName'), variables('resourceGroupNameFunctionApp'))]",
    "resourceGroupNames": [
      "[variables('resourceGroupNameNetworking')]",
      "[variables('resourceGroupNameHostingPlan')]",
      "[variables('resourceGroupNameFunctionApp')]"
    ]
  },
  "resources": [
    {
      "copy": {
        "name": "rgs",
        "count": "[length(union(variables('resourceGroupNames'), variables('resourceGroupNames')))]"
      },
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2023-07-01",
      "name": "[union(variables('resourceGroupNames'), variables('resourceGroupNames'))[copyIndex()]]",
      "location": "[parameters('location')]"
    },
    {
      "condition": "[and(parameters('deployNetworking'), or(parameters('enableVnetIntegration'), parameters('enableInboundPrivateEndpoint')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))]",
      "resourceGroup": "[variables('resourceGroupNameNetworking')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "privateDnsZoneNames": "[if(parameters('deployStoragePrivateDnsZones'), if(parameters('deployFunctionAppPrivateDnsZone'), createObject('value', union(variables('storagePrivateDnsZoneNames'), variables('webSitePrivateDnsZoneName'))), createObject('value', variables('storagePrivateDnsZoneNames'))), if(parameters('deployFunctionAppPrivateDnsZone'), createObject('value', variables('webSitePrivateDnsZoneName')), createObject('value', createArray())))]",
          "subnets": {
            "value": "[union(variables('subnetOutbound'), variables('subnetStoragePrivateEndpoints'), variables('subnetInboundPrivateEndpoint'))]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('vnetAddressPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.31.92.45157",
              "templateHash": "10110989535071959642"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "privateDnsZoneNames": {
              "type": "array"
            },
            "vnetName": {
              "type": "string"
            },
            "vnetAddressPrefix": {
              "type": "string"
            },
            "subnets": {
              "type": "array"
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2022-05-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                }
              },
              "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Network/virtualNetworks'), createObject())]"
            },
            {
              "copy": {
                "name": "snets",
                "count": "[length(parameters('subnets'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2022-05-01",
              "name": "[format('{0}/{1}', parameters('vnetName'), parameters('subnets')[copyIndex()].name)]",
              "properties": "[parameters('subnets')[copyIndex()].properties]",
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneNames')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('privateDns-virtualNetworkLinks-{0}', uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "privateDnsZoneNames": {
                    "value": "[parameters('privateDnsZoneNames')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "vnetId": {
                    "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.31.92.45157",
                      "templateHash": "10682769902782451491"
                    }
                  },
                  "parameters": {
                    "privateDnsZoneNames": {
                      "type": "array"
                    },
                    "vnetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "privateDnsZones",
                        "count": "[length(parameters('privateDnsZoneNames'))]"
                      },
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('privateDnsZoneNames')[copyIndex()]]",
                      "location": "global",
                      "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateDnsZones'), createObject())]"
                    },
                    {
                      "copy": {
                        "name": "virtualNetworkLinks",
                        "count": "[length(parameters('privateDnsZoneNames'))]"
                      },
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2018-09-01",
                      "name": "[format('{0}/{1}', parameters('privateDnsZoneNames')[copyIndex()], last(split(parameters('vnetId'), '/')))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vnetId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneNames')[copyIndex()])]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "snets",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
              ]
            }
          ],
          "outputs": {
            "subnetIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('subnets'))]",
                "input": "[format('{0}/subnets/{1}', resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), parameters('subnets')[copyIndex()].name)]"
              }
            },
            "privateDnsZoneIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('privateDnsZoneNames'))]",
                "input": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneNames')[copyIndex()])]"
              }
            },
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "rgs"
      ]
    },
    {
      "condition": "[parameters('deployHostingPlan')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('hostingPlan-{0}', uniqueString(deployment().name, parameters('location')))]",
      "resourceGroup": "[variables('resourceGroupNameHostingPlan')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppKind": {
            "value": "[parameters('functionAppKind')]"
          },
          "hostingPlanType": {
            "value": "[parameters('hostingPlanType')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceId')]"
          },
          "name": {
            "value": "[parameters('hostingPlanName')]"
          },
          "planPricing": {
            "value": "[parameters('hostingPlanPricing')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "zoneRedundant": {
            "value": "[parameters('hostingPlanZoneRedundant')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.31.92.45157",
              "templateHash": "4501866862127807748"
            }
          },
          "parameters": {
            "hostingPlanType": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "functionAppKind": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "planPricing": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "zoneRedundant": {
              "type": "bool"
            }
          },
          "variables": {
            "sku": {
              "name": "[split(parameters('planPricing'), '_')[1]]",
              "tier": "[split(parameters('planPricing'), '_')[0]]",
              "capacity": "[if(parameters('zoneRedundant'), 3, 1)]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": "[variables('sku')]",
              "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Web/serverfarms'), createObject())]",
              "properties": {
                "maximumElasticWorkerCount": "[if(equals(parameters('hostingPlanType'), 'FunctionsPremium'), 20, 1)]",
                "reserved": "[if(contains(parameters('functionAppKind'), 'linux'), true(), false())]",
                "zoneRedundant": "[parameters('zoneRedundant')]"
              }
            },
            {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/serverfarms/{0}', parameters('name'))]",
              "name": "[format('{0}-diagnosticSettings', parameters('name'))]",
              "properties": {
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "hostingPlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "rgs"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('storage-resources-{0}', uniqueString(deployment().name, parameters('location')))]",
      "resourceGroup": "[variables('resourceGroupNameStorage')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "containerName": "[if(or(and(parameters('deployHostingPlan'), or(equals(parameters('hostingPlanType'), 'FlexConsumption'), and(not(equals(parameters('hostingPlanType'), 'AppServicePlan')), not(parameters('addAzureFilesConnection'))))), and(not(parameters('deployHostingPlan')), or(equals(if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'))), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Flex'), 'FlexConsumption', if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Elastic'), 'FunctionsPremium', if(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Dynamic'), 'Consumption', 'AppServicePlan'))), ''), 'FlexConsumption'), and(not(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'), 'AppServicePlan')), not(parameters('addAzureFilesConnection')))))), createObject('value', format('app-package-{0}', toLower(parameters('functionAppName')))), createObject('value', ''))]",
          "deployStorageAccount": {
            "value": "[parameters('deployStorageAccount')]"
          },
          "enableStoragePrivateEndpoints": {
            "value": "[parameters('enableStoragePrivateEndpoints')]"
          },
          "fileShareName": "[if(or(and(parameters('deployHostingPlan'), or(equals(parameters('hostingPlanType'), 'Consumption'), equals(parameters('hostingPlanType'), 'FunctionsPremium'))), and(not(parameters('deployHostingPlan')), or(equals(if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'))), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Flex'), 'FlexConsumption', if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Elastic'), 'FunctionsPremium', if(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Dynamic'), 'Consumption', 'AppServicePlan'))), ''), 'Consumption'), equals(if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'))), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Flex'), 'FlexConsumption', if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Elastic'), 'FunctionsPremium', if(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Dynamic'), 'Consumption', 'AppServicePlan'))), ''), 'FunctionsPremium')))), if(parameters('addAzureFilesConnection'), createObject('value', toLower(parameters('functionAppName'))), createObject('value', '')), createObject('value', ''))]",
          "hostPlanType": "[if(parameters('deployHostingPlan'), createObject('value', parameters('hostingPlanType')), if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'))), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Flex'), createObject('value', 'FlexConsumption'), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Elastic'), createObject('value', 'FunctionsPremium'), if(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Dynamic'), createObject('value', 'Consumption'), createObject('value', 'AppServicePlan')))), createObject('value', '')))]",
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceId')]"
          },
          "privateEndpointNameConv": {
            "value": "[variables('privateEndpointNameConv')]"
          },
          "privateEndpointNICNameConv": {
            "value": "[variables('privateEndpointNICNameConv')]"
          },
          "storageAccountId": {
            "value": "[parameters('storageAccountId')]"
          },
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "storageAccountPrivateEndpointSubnetId": "[if(parameters('enableStoragePrivateEndpoints'), if(parameters('deployNetworking'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.subnetIds.value[1]), createObject('value', parameters('storagePrivateEndpointSubnetId'))), createObject('value', ''))]",
          "storageAccountSku": "[if(parameters('deployHostingPlan'), if(parameters('hostingPlanZoneRedundant'), createObject('value', 'Standard_ZRS'), createObject('value', 'Standard_LRS')), if(greater(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01').numberOfWorkers, 1), createObject('value', 'Standard_ZRS'), createObject('value', 'Standard_LRS')))]",
          "storageBlobDnsZoneId": "[if(parameters('enableStoragePrivateEndpoints'), if(and(parameters('deployNetworking'), parameters('deployStoragePrivateDnsZones')), createObject('value', first(filter(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.privateDnsZoneIds.value, lambda('zone', contains(lambdaVariables('zone'), '.blob.'))))), createObject('value', parameters('storageBlobDnsZoneId'))), createObject('value', ''))]",
          "storageFileDnsZoneId": "[if(parameters('enableStoragePrivateEndpoints'), if(and(parameters('deployNetworking'), parameters('deployStoragePrivateDnsZones')), createObject('value', first(filter(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.privateDnsZoneIds.value, lambda('zone', contains(lambdaVariables('zone'), '.file.'))))), createObject('value', parameters('storageFileDnsZoneId'))), createObject('value', ''))]",
          "storageQueueDnsZoneId": "[if(parameters('enableStoragePrivateEndpoints'), if(and(parameters('deployNetworking'), parameters('deployStoragePrivateDnsZones')), createObject('value', first(filter(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.privateDnsZoneIds.value, lambda('zone', contains(lambdaVariables('zone'), '.queue.'))))), createObject('value', parameters('storageQueueDnsZoneId'))), createObject('value', ''))]",
          "storageTableDnsZoneId": "[if(parameters('enableStoragePrivateEndpoints'), if(and(parameters('deployNetworking'), parameters('deployStoragePrivateDnsZones')), createObject('value', first(filter(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.privateDnsZoneIds.value, lambda('zone', contains(lambdaVariables('zone'), '.table.'))))), createObject('value', parameters('storageTableDnsZoneId'))), createObject('value', ''))]",
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.31.92.45157",
              "templateHash": "5323884478491822608"
            }
          },
          "parameters": {
            "containerName": {
              "type": "string"
            },
            "deployStorageAccount": {
              "type": "bool"
            },
            "enableStoragePrivateEndpoints": {
              "type": "bool"
            },
            "fileShareName": {
              "type": "string"
            },
            "hostPlanType": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "privateEndpointNameConv": {
              "type": "string"
            },
            "privateEndpointNICNameConv": {
              "type": "string"
            },
            "storageAccountId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountPrivateEndpointSubnetId": {
              "type": "string"
            },
            "storageAccountSku": {
              "type": "string"
            },
            "storageBlobDnsZoneId": {
              "type": "string"
            },
            "storageFileDnsZoneId": {
              "type": "string"
            },
            "storageQueueDnsZoneId": {
              "type": "string"
            },
            "storageTableDnsZoneId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "storageAccountNameVar": "[if(parameters('deployStorageAccount'), parameters('storageAccountName'), last(split(parameters('storageAccountId'), '/')))]",
            "vnetName": "[if(not(empty(parameters('storageAccountPrivateEndpointSubnetId'))), split(parameters('storageAccountPrivateEndpointSubnetId'), '/')[8], '')]",
            "privateEndpointName": "[if(greater(length(replace(replace(parameters('privateEndpointNameConv'), 'RESOURCENAME', parameters('storageAccountName')), 'VNET', variables('vnetName'))), 66), replace(replace(parameters('privateEndpointNameConv'), 'RESOURCENAME', replace(variables('storageAccountNameVar'), '-', '')), 'VNET', replace(variables('vnetName'), '-', '')), replace(replace(parameters('privateEndpointNameConv'), 'RESOURCENAME', variables('storageAccountNameVar')), 'VNET', variables('vnetName')))]",
            "privateEndpointNICName": "[if(greater(length(replace(replace(parameters('privateEndpointNICNameConv'), 'RESOURCENAME', variables('storageAccountNameVar')), 'VNET', variables('vnetName'))), 82), replace(replace(parameters('privateEndpointNICNameConv'), 'RESOURCENAME', replace(variables('storageAccountNameVar'), '-', '')), 'VNET', replace(variables('vnetName'), '-', '')), replace(replace(parameters('privateEndpointNICNameConv'), 'RESOURCENAME', variables('storageAccountNameVar')), 'VNET', variables('vnetName')))]",
            "blobPE": "[if(not(empty(parameters('storageBlobDnsZoneId'))), createArray(createObject('customNICName', replace(variables('privateEndpointNICName'), 'SERVICE', 'blob'), 'name', replace(variables('privateEndpointName'), 'SERVICE', 'blob'), 'privateDnsZoneId', parameters('storageBlobDnsZoneId'), 'service', 'blob')), createArray())]",
            "filePE": "[if(not(empty(parameters('storageFileDnsZoneId'))), createArray(createObject('customNICName', replace(variables('privateEndpointNICName'), 'SERVICE', 'file'), 'name', replace(variables('privateEndpointName'), 'SERVICE', 'file'), 'privateDnsZoneId', parameters('storageFileDnsZoneId'), 'service', 'file')), createArray())]",
            "queuePE": "[if(not(empty(parameters('storageQueueDnsZoneId'))), createArray(createObject('customNICName', replace(variables('privateEndpointNICName'), 'SERVICE', 'queue'), 'name', replace(variables('privateEndpointName'), 'SERVICE', 'queue'), 'privateDnsZoneId', parameters('storageQueueDnsZoneId'), 'service', 'queue')), createArray())]",
            "tablePE": "[if(not(empty(parameters('storageTableDnsZoneId'))), createArray(createObject('customNICName', replace(variables('privateEndpointNICName'), 'SERVICE', 'table'), 'name', replace(variables('privateEndpointNICName'), 'SERVICE', 'table'), 'privateDnsZoneId', parameters('storageTableDnsZoneId'), 'service', 'table')), createArray())]",
            "storageAccountPrivateEndpoints": "[if(and(parameters('enableStoragePrivateEndpoints'), not(empty(variables('vnetName')))), union(variables('blobPE'), variables('filePE'), variables('queuePE'), variables('tablePE')), createArray())]"
          },
          "resources": [
            {
              "condition": "[parameters('deployStorageAccount')]",
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountNameVar'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameVar'))]"
              ]
            },
            {
              "condition": "[and(parameters('deployStorageAccount'), not(empty(parameters('fileShareName'))))]",
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountNameVar'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameVar'))]"
              ]
            },
            {
              "condition": "[parameters('deployStorageAccount')]",
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('storageAccountNameVar')]",
              "location": "[parameters('location')]",
              "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Storage/storageAccounts'), createObject())]",
              "sku": {
                "name": "[parameters('storageAccountSku')]"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowedCopyScope": "PrivateLink",
                "allowCrossTenantReplication": false,
                "allowSharedKeyAccess": "[if(and(not(equals(parameters('hostPlanType'), 'AppServicePlan')), not(equals(parameters('hostPlanType'), 'FlexConsumption'))), true(), false())]",
                "defaultToOAuthAuthentication": false,
                "encryption": {
                  "keySource": "Microsoft.Storage",
                  "requireInfrastructureEncryption": true,
                  "services": {
                    "blob": {
                      "enabled": true
                    },
                    "file": {
                      "enabled": true
                    },
                    "queue": {
                      "enabled": true
                    },
                    "table": {
                      "enabled": true
                    }
                  }
                },
                "largeFileSharesState": "Enabled",
                "minimumTlsVersion": "TLS1_2",
                "networkAcls": "[if(parameters('enableStoragePrivateEndpoints'), createObject('bypass', 'AzureServices', 'defaultAction', 'Deny', 'ipRules', createArray(), 'virtualNetworkRules', createArray()), null())]",
                "publicNetworkAccess": "[if(parameters('enableStoragePrivateEndpoints'), 'Disabled', 'Enabled')]",
                "sasPolicy": {
                  "expirationAction": "Log",
                  "sasExpirationPeriod": "180.00:00:00"
                }
              }
            },
            {
              "condition": "[and(parameters('deployStorageAccount'), and(parameters('deployStorageAccount'), not(empty(parameters('fileShareName')))))]",
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountNameVar'), 'default', parameters('fileShareName'))]",
              "properties": {
                "enabledProtocols": "SMB",
                "shareQuota": 5120
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', variables('storageAccountNameVar'), 'default')]"
              ]
            },
            {
              "condition": "[and(parameters('deployStorageAccount'), and(parameters('deployStorageAccount'), not(empty(parameters('containerName')))))]",
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountNameVar'), 'default', parameters('containerName'))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountNameVar'), 'default')]"
              ]
            },
            {
              "condition": "[and(and(not(parameters('deployStorageAccount')), not(empty(parameters('storageAccountId')))), not(empty(parameters('fileShareName'))))]",
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountNameVar'), 'default')]"
            },
            {
              "condition": "[and(and(not(parameters('deployStorageAccount')), not(empty(parameters('storageAccountId')))), not(empty(parameters('fileShareName'))))]",
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountNameVar'), 'default', parameters('fileShareName'))]",
              "properties": {
                "enabledProtocols": "SMB",
                "shareQuota": 5120
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', variables('storageAccountNameVar'), 'default')]"
              ]
            },
            {
              "condition": "[and(and(not(parameters('deployStorageAccount')), not(empty(parameters('storageAccountId')))), not(empty(parameters('containerName'))))]",
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountNameVar'), 'default')]"
            },
            {
              "condition": "[and(and(not(parameters('deployStorageAccount')), not(empty(parameters('storageAccountId')))), not(empty(parameters('containerName'))))]",
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountNameVar'), 'default', parameters('containerName'))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountNameVar'), 'default')]"
              ]
            },
            {
              "copy": {
                "name": "storageAccount_privateEndpoints",
                "count": "[length(variables('storageAccountPrivateEndpoints'))]"
              },
              "condition": "[parameters('enableStoragePrivateEndpoints')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[variables('storageAccountPrivateEndpoints')[copyIndex()].name]",
              "location": "[parameters('location')]",
              "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject())]",
              "properties": {
                "customNetworkInterfaceName": "[variables('storageAccountPrivateEndpoints')[copyIndex()].customNICName]",
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('storageAccountPrivateEndpoints')[copyIndex()].name]",
                    "properties": {
                      "privateLinkServiceId": "[if(parameters('deployStorageAccount'), resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameVar')), resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameVar')))]",
                      "groupIds": [
                        "[variables('storageAccountPrivateEndpoints')[copyIndex()].service]"
                      ]
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('storageAccountPrivateEndpointSubnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameVar'))]"
              ]
            },
            {
              "copy": {
                "name": "storageAccount_PrivateDnsZoneGroups",
                "count": "[length(variables('storageAccountPrivateEndpoints'))]"
              },
              "condition": "[and(parameters('enableStoragePrivateEndpoints'), not(empty(variables('storageAccountPrivateEndpoints')[copyIndex()].privateDnsZoneId)))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-06-01",
              "name": "[format('{0}/{1}', variables('storageAccountPrivateEndpoints')[copyIndex()].name, variables('storageAccountPrivateEndpoints')[copyIndex()].name)]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[if(not(empty(variables('storageAccountPrivateEndpoints')[copyIndex()].privateDnsZoneId)), format('{0}-config', last(split(variables('storageAccountPrivateEndpoints')[copyIndex()].privateDnsZoneId, '/'))), '')]",
                    "properties": {
                      "privateDnsZoneId": "[variables('storageAccountPrivateEndpoints')[copyIndex()].privateDnsZoneId]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('storageAccountPrivateEndpoints')[copyIndex()].name)]"
              ]
            },
            {
              "condition": "[and(parameters('deployStorageAccount'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountNameVar'))]",
              "name": "[format('{0}-diagnosticSettings', parameters('storageAccountName'))]",
              "properties": {
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameVar'))]"
              ]
            },
            {
              "condition": "[and(parameters('deployStorageAccount'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}', variables('storageAccountNameVar'), 'default')]",
              "name": "[format('{0}-blob-diagnosticSettings', parameters('storageAccountName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "StorageWrite",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountNameVar'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountResourceId": {
              "type": "string",
              "value": "[if(parameters('deployStorageAccount'), resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameVar')), resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameVar')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location'))))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('functionApp-resources-{0}', uniqueString(deployment().name, parameters('location')))]",
      "resourceGroup": "[parameters('functionAppResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "blobContainerName": "[if(or(and(parameters('deployHostingPlan'), or(equals(parameters('hostingPlanType'), 'FlexConsumption'), and(not(equals(parameters('hostingPlanType'), 'AppServicePlan')), not(parameters('addAzureFilesConnection'))))), and(not(parameters('deployHostingPlan')), or(equals(if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'))), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Flex'), 'FlexConsumption', if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Elastic'), 'FunctionsPremium', if(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Dynamic'), 'Consumption', 'AppServicePlan'))), ''), 'FlexConsumption'), and(not(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'), 'AppServicePlan')), not(parameters('addAzureFilesConnection')))))), createObject('value', format('app-package-{0}', toLower(parameters('functionAppName')))), createObject('value', ''))]",
          "enableApplicationInsights": {
            "value": "[parameters('enableApplicationInsights')]"
          },
          "enablePublicAccess": {
            "value": "[parameters('enablePublicAccess')]"
          },
          "enableInboundPrivateEndpoint": {
            "value": "[parameters('enableInboundPrivateEndpoint')]"
          },
          "fileShareName": "[if(or(and(parameters('deployHostingPlan'), or(equals(parameters('hostingPlanType'), 'Consumption'), equals(parameters('hostingPlanType'), 'FunctionsPremium'))), and(not(parameters('deployHostingPlan')), or(equals(if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'))), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Flex'), 'FlexConsumption', if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Elastic'), 'FunctionsPremium', if(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Dynamic'), 'Consumption', 'AppServicePlan'))), ''), 'Consumption'), equals(if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'))), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Flex'), 'FlexConsumption', if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Elastic'), 'FunctionsPremium', if(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Dynamic'), 'Consumption', 'AppServicePlan'))), ''), 'FunctionsPremium')))), if(parameters('addAzureFilesConnection'), createObject('value', toLower(parameters('functionAppName'))), createObject('value', '')), createObject('value', ''))]",
          "functionAppKind": {
            "value": "[parameters('functionAppKind')]"
          },
          "functionAppName": {
            "value": "[parameters('functionAppName')]"
          },
          "functionAppOutboundSubnetId": "[if(parameters('enableVnetIntegration'), if(parameters('deployNetworking'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.subnetIds.value[0]), createObject('value', parameters('functionAppOutboundSubnetId'))), createObject('value', ''))]",
          "functionAppInboundSubnetId": "[if(parameters('enableInboundPrivateEndpoint'), if(parameters('deployNetworking'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.subnetIds.value[2]), createObject('value', parameters('functionAppInboundSubnetId'))), createObject('value', ''))]",
          "functionAppPrivateDnsZoneId": "[if(parameters('enableInboundPrivateEndpoint'), if(and(parameters('deployNetworking'), parameters('deployFunctionAppPrivateDnsZone')), createObject('value', first(filter(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.privateDnsZoneIds.value, lambda('zone', contains(lambdaVariables('zone'), variables('webSitePrivateDnsZoneName')))))), createObject('value', parameters('functionAppPrivateDnsZoneId'))), createObject('value', ''))]",
          "hostingPlanType": "[if(parameters('deployHostingPlan'), createObject('value', parameters('hostingPlanType')), if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full'))), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Flex'), createObject('value', 'FlexConsumption'), if(contains(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Elastic'), createObject('value', 'FunctionsPremium'), if(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('hostingPlanId'), '/')[2], split(parameters('hostingPlanId'), '/')[4]), 'Microsoft.Web/serverfarms', last(split(parameters('hostingPlanId'), '/'))), '2023-01-01', 'full').sku.tier, 'Dynamic'), createObject('value', 'Consumption'), createObject('value', 'AppServicePlan')))), createObject('value', '')))]",
          "hostingPlanId": "[if(parameters('deployHostingPlan'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameHostingPlan')), 'Microsoft.Resources/deployments', format('hostingPlan-{0}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.hostingPlanId.value), createObject('value', parameters('hostingPlanId')))]",
          "ipSecurityRestrictions": {
            "value": "[parameters('ipSecurityRestrictions')]"
          },
          "ipSecurityRestrictionsDefaultAction": {
            "value": "[parameters('ipSecurityRestrictionsDefaultAction')]"
          },
          "scmIpSecurityRestrictions": {
            "value": "[parameters('scmIpSecurityRestrictions')]"
          },
          "scmIpSecurityRestrictionsDefaultAction": {
            "value": "[parameters('scmIpSecurityRestrictionsDefaultAction')]"
          },
          "scmIpSecurityRestrictionsUseMain": {
            "value": "[parameters('scmIpSecurityRestrictionsUseMain')]"
          },
          "privateEndpointNameConv": {
            "value": "[variables('privateEndpointNameConv')]"
          },
          "privateEndpointNICNameConv": {
            "value": "[variables('privateEndpointNICNameConv')]"
          },
          "privateLinkScopeResourceId": {
            "value": "[parameters('privateLinkScopeResourceId')]"
          },
          "runtimeStack": {
            "value": "[parameters('runtimeStack')]"
          },
          "runtimeVersion": {
            "value": "[parameters('runtimeVersion')]"
          },
          "storageAccountResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameStorage')), 'Microsoft.Resources/deployments', format('storage-resources-{0}', uniqueString(deployment().name, parameters('location')))), '2022-09-01').outputs.storageAccountResourceId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceId')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "instanceMemoryMB": {
            "value": "[parameters('flexConsumptionInstanceMemoryMB')]"
          },
          "maximumInstanceCount": {
            "value": "[parameters('flexConsumptionMaximumInstanceCount')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.31.92.45157",
              "templateHash": "3552857474428145944"
            }
          },
          "parameters": {
            "blobContainerName": {
              "type": "string"
            },
            "enableApplicationInsights": {
              "type": "bool"
            },
            "enableInboundPrivateEndpoint": {
              "type": "bool"
            },
            "enablePublicAccess": {
              "type": "bool"
            },
            "functionAppInboundSubnetId": {
              "type": "string"
            },
            "functionAppName": {
              "type": "string"
            },
            "functionAppOutboundSubnetId": {
              "type": "string"
            },
            "hostingPlanId": {
              "type": "string",
              "nullable": true
            },
            "hostingPlanType": {
              "type": "string"
            },
            "ipSecurityRestrictions": {
              "type": "array"
            },
            "ipSecurityRestrictionsDefaultAction": {
              "type": "string"
            },
            "scmIpSecurityRestrictions": {
              "type": "array"
            },
            "scmIpSecurityRestrictionsDefaultAction": {
              "type": "string"
            },
            "scmIpSecurityRestrictionsUseMain": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "fileShareName": {
              "type": "string"
            },
            "functionAppKind": {
              "type": "string"
            },
            "functionAppPrivateDnsZoneId": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "maximumInstanceCount": {
              "type": "int"
            },
            "privateEndpointNameConv": {
              "type": "string"
            },
            "privateEndpointNICNameConv": {
              "type": "string"
            },
            "privateLinkScopeResourceId": {
              "type": "string"
            },
            "instanceMemoryMB": {
              "type": "int"
            },
            "runtimeVersion": {
              "type": "string"
            },
            "runtimeStack": {
              "type": "string"
            },
            "storageAccountResourceId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "functionsWorkerRuntime": "[if(or(equals(parameters('runtimeVersion'), '.NET Framework 4.8'), contains(parameters('runtimeVersion'), 'Isolated')), format('{0}-isolated', parameters('runtimeStack')), parameters('runtimeStack'))]",
            "firstRuntimeVersion": "[split(parameters('runtimeVersion'), ' ')[0]]",
            "decimalRuntimeVersion": "[if(equals(parameters('runtimeVersion'), '.NET Framework 4.8'), '4.0', if(and(equals(parameters('runtimeStack'), 'dotnet'), equals(length(variables('firstRuntimeVersion')), 1)), format('{0}.0', variables('firstRuntimeVersion')), variables('firstRuntimeVersion')))]",
            "linuxRuntimeStack": "[if(contains(variables('functionsWorkerRuntime'), 'dotnet'), toUpper(variables('functionsWorkerRuntime')), if(equals(parameters('runtimeStack'), 'node'), 'Node', if(equals(parameters('runtimeStack'), 'powershell'), 'PowerShell', if(equals(parameters('runtimeStack'), 'python'), 'Python', if(equals(parameters('runtimeStack'), 'java'), 'Java', null())))))]",
            "noFileShareAppSettings": [
              {
                "name": "AzureWebJobsStorage__blobServiceUri",
                "value": "[format('https://{0}.blob.{1}', last(split(parameters('storageAccountResourceId'), '/')), environment().suffixes.storage)]"
              },
              {
                "name": "AzureWebJobsStorage__credential",
                "value": "managedidentity"
              },
              {
                "name": "AzureWebJobsStorage__queueServiceUri",
                "value": "[format('https://{0}.queue.{1}', last(split(parameters('storageAccountResourceId'), '/')), environment().suffixes.storage)]"
              },
              {
                "name": "AzureWebJobsStorage__tableServiceUri",
                "value": "[format('https://{0}.table.{1}', last(split(parameters('storageAccountResourceId'), '/')), environment().suffixes.storage)]"
              },
              {
                "name": "FUNCTIONS_EXTENSION_VERSION",
                "value": "~4"
              },
              {
                "name": "FUNCTIONS_WORKER_RUNTIME",
                "value": "[variables('functionsWorkerRuntime')]"
              },
              {
                "name": "WEBSITE_LOAD_USER_PROFILE",
                "value": "1"
              }
            ],
            "isolatedAppSettings": "[if(contains(variables('functionsWorkerRuntime'), 'isolated'), createArray(createObject('name', 'WEBSITE_USE_PLACEHOLDER_DOTNETISOLATED', 'value', '1')), createArray())]",
            "windowsAppSettings": "[if(equals(parameters('functionAppKind'), 'functionapp'), createArray(createObject('name', 'WEBSITE_NODE_DEFAULT_VERSION', 'value', format('~{0}', variables('decimalRuntimeVersion')))), createArray())]",
            "siteConfigNetworkRestrictions": {
              "ipSecurityRestrictions": "[if(empty(parameters('ipSecurityRestrictions')), null(), parameters('ipSecurityRestrictions'))]",
              "ipSecurityRestrictionsDefaultAction": "[if(empty(parameters('ipSecurityRestrictions')), null(), parameters('ipSecurityRestrictionsDefaultAction'))]",
              "scmIpSecurityRestrictions": "[if(empty(parameters('scmIpSecurityRestrictions')), null(), parameters('scmIpSecurityRestrictions'))]",
              "scmIpSecurityRestrictionsDefaultAction": "[if(empty(parameters('scmIpSecurityRestrictions')), null(), parameters('scmIpSecurityRestrictionsDefaultAction'))]",
              "scmIpSecurityRestrictionsUseMain": "[if(and(empty(parameters('ipSecurityRestrictions')), empty(parameters('scmIpSecurityRestrictions'))), null(), parameters('scmIpSecurityRestrictionsUseMain'))]"
            },
            "vnetName": "[if(not(empty(parameters('functionAppInboundSubnetId'))), split(parameters('functionAppInboundSubnetId'), '/')[8], '')]",
            "privateEndpointName": "[if(greater(length(replace(replace(replace(parameters('privateEndpointNameConv'), 'RESOURCENAME', parameters('functionAppName')), 'SERVICE', 'sites'), 'VNET', variables('vnetName'))), 64), replace(replace(replace(parameters('privateEndpointNameConv'), 'RESOURCENAME', replace(parameters('functionAppName'), '-', '')), 'SERVICE', 'sites'), 'VNET', replace(variables('vnetName'), '-', '')), replace(replace(replace(parameters('privateEndpointNameConv'), 'RESOURCENAME', parameters('functionAppName')), 'SERVICE', 'sites'), 'VNET', variables('vnetName')))]",
            "privateEndpointNICName": "[if(greater(length(replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SERVICE', 'sites'), 'RESOURCENAME', parameters('functionAppName')), 'VNET', variables('vnetName'))), 80), replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SERVICE', 'sites'), 'RESOURCENAME', replace(parameters('functionAppName'), '-', '')), 'VNET', replace(variables('vnetName'), '-', '')), replace(replace(replace(parameters('privateEndpointNICNameConv'), 'SERVICE', 'sites'), 'RESOURCENAME', parameters('functionAppName')), 'VNET', variables('vnetName')))]"
          },
          "resources": {
            "storageAccount": {
              "existing": true,
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "subscriptionId": "[split(parameters('storageAccountResourceId'), '/')[2]]",
              "resourceGroup": "[split(parameters('storageAccountResourceId'), '/')[4]]",
              "name": "[last(split(parameters('storageAccountResourceId'), '/'))]"
            },
            "applicationInsights": {
              "condition": "[parameters('enableApplicationInsights')]",
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[format('{0}-insights', parameters('functionAppName'))]",
              "kind": "web",
              "location": "[parameters('location')]",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[if(not(empty(parameters('logAnalyticsWorkspaceId'))), parameters('logAnalyticsWorkspaceId'), null())]"
              },
              "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Insights/components'), createObject())]"
            },
            "privateLinkScope": {
              "existing": true,
              "type": "Microsoft.Network/privateLinkServices",
              "apiVersion": "2020-11-01",
              "subscriptionId": "[split(parameters('privateLinkScopeResourceId'), '/')[2]]",
              "resourceGroup": "[split(parameters('privateLinkScopeResourceId'), '/')[4]]",
              "name": "[last(split(parameters('privateLinkScopeResourceId'), '/'))]"
            },
            "functionApp": {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('functionAppName')]",
              "identity": "[if(or(empty(parameters('fileShareName')), equals(parameters('hostingPlanType'), 'FlexConsumption')), createObject('type', 'SystemAssigned'), null())]",
              "kind": "[parameters('functionAppKind')]",
              "location": "[parameters('location')]",
              "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Web/sites'), createObject())]",
              "properties": {
                "httpsOnly": true,
                "functionAppConfig": "[if(equals(parameters('hostingPlanType'), 'FlexConsumption'), createObject('deployment', createObject('storage', createObject('type', 'blobContainer', 'value', format('{0}{1}', reference('storageAccount').primaryEndpoints.blob, toLower(parameters('blobContainerName'))), 'authentication', createObject('type', 'SystemAssignedIdentity'))), 'scaleAndConcurrency', createObject('maximumInstanceCount', parameters('maximumInstanceCount'), 'instanceMemoryMB', parameters('instanceMemoryMB')), 'runtime', createObject('name', variables('functionsWorkerRuntime'), 'version', variables('decimalRuntimeVersion'))), null())]",
                "publicNetworkAccess": "[if(parameters('enablePublicAccess'), 'Enabled', 'Disabled')]",
                "serverFarmId": "[if(not(empty(parameters('hostingPlanId'))), parameters('hostingPlanId'), null())]",
                "siteConfig": "[if(equals(parameters('hostingPlanType'), 'FlexConsumption'), union(createObject('appSettings', if(equals(parameters('hostingPlanType'), 'FlexConsumption'), union(if(equals(environment().name, 'AzureCloud'), createArray(createObject('name', 'AzureWebJobsStorage__accountName', 'value', last(split(parameters('storageAccountResourceId'), '/')))), createArray(createObject('name', 'AzureWebJobsStorage__blobServiceUri', 'value', substring(reference('storageAccount').primaryEndpoints.blob, 0, sub(length(reference('storageAccount').primaryEndpoints.blob), 1))), createObject('name', 'AzureWebJobsStorage__queueServiceUri', 'value', substring(reference('storageAccount').primaryEndpoints.queue, 0, sub(length(reference('storageAccount').primaryEndpoints.queue), 1))), createObject('name', 'AzureWebJobsStorage__tableServiceUri', 'value', substring(reference('storageAccount').primaryEndpoints.table, 0, sub(length(reference('storageAccount').primaryEndpoints.table), 1))), createObject('name', 'AzureWebJobsStorage__fileServiceUri', 'value', substring(reference('storageAccount').primaryEndpoints.file, 0, sub(length(reference('storageAccount').primaryEndpoints.file), 1))))), if(parameters('enableApplicationInsights'), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference('applicationInsights').ConnectionString)), createArray())), if(empty(parameters('fileShareName')), union(variables('noFileShareAppSettings'), if(parameters('enableApplicationInsights'), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference('applicationInsights').ConnectionString)), createArray()), variables('isolatedAppSettings'), variables('windowsAppSettings')), union(createArray(createObject('name', 'AzureWebJobsStorage', 'value', format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', last(split(parameters('storageAccountResourceId'), '/')), environment().suffixes.storage, listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('storageAccountResourceId'), '/')[2], split(parameters('storageAccountResourceId'), '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('storageAccountResourceId'), '/'))), '2021-04-01').keys[0].value)), createObject('name', 'WEBSITE_CONTENTAZUREFILECONNECTIONSTRING', 'value', format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', last(split(parameters('storageAccountResourceId'), '/')), environment().suffixes.storage, listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('storageAccountResourceId'), '/')[2], split(parameters('storageAccountResourceId'), '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('storageAccountResourceId'), '/'))), '2021-04-01').keys[0].value)), createObject('name', 'WEBSITE_CONTENTSHARE', 'value', toLower(parameters('functionAppName'))), createObject('name', 'FUNCTIONS_EXTENSION_VERSION', 'value', '~4'), createObject('name', 'FUNCTIONS_WORKER_RUNTIME', 'value', variables('functionsWorkerRuntime'))), if(parameters('enableApplicationInsights'), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference('applicationInsights').ConnectionString)), createArray()), variables('isolatedAppSettings'), variables('windowsAppSettings'))))), variables('siteConfigNetworkRestrictions')), union(createObject('appSettings', if(equals(parameters('hostingPlanType'), 'FlexConsumption'), union(if(equals(environment().name, 'AzureCloud'), createArray(createObject('name', 'AzureWebJobsStorage__accountName', 'value', last(split(parameters('storageAccountResourceId'), '/')))), createArray(createObject('name', 'AzureWebJobsStorage__blobServiceUri', 'value', substring(reference('storageAccount').primaryEndpoints.blob, 0, sub(length(reference('storageAccount').primaryEndpoints.blob), 1))), createObject('name', 'AzureWebJobsStorage__queueServiceUri', 'value', substring(reference('storageAccount').primaryEndpoints.queue, 0, sub(length(reference('storageAccount').primaryEndpoints.queue), 1))), createObject('name', 'AzureWebJobsStorage__tableServiceUri', 'value', substring(reference('storageAccount').primaryEndpoints.table, 0, sub(length(reference('storageAccount').primaryEndpoints.table), 1))), createObject('name', 'AzureWebJobsStorage__fileServiceUri', 'value', substring(reference('storageAccount').primaryEndpoints.file, 0, sub(length(reference('storageAccount').primaryEndpoints.file), 1))))), if(parameters('enableApplicationInsights'), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference('applicationInsights').ConnectionString)), createArray())), if(empty(parameters('fileShareName')), union(variables('noFileShareAppSettings'), if(parameters('enableApplicationInsights'), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference('applicationInsights').ConnectionString)), createArray()), variables('isolatedAppSettings'), variables('windowsAppSettings')), union(createArray(createObject('name', 'AzureWebJobsStorage', 'value', format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', last(split(parameters('storageAccountResourceId'), '/')), environment().suffixes.storage, listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('storageAccountResourceId'), '/')[2], split(parameters('storageAccountResourceId'), '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('storageAccountResourceId'), '/'))), '2021-04-01').keys[0].value)), createObject('name', 'WEBSITE_CONTENTAZUREFILECONNECTIONSTRING', 'value', format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', last(split(parameters('storageAccountResourceId'), '/')), environment().suffixes.storage, listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('storageAccountResourceId'), '/')[2], split(parameters('storageAccountResourceId'), '/')[4]), 'Microsoft.Storage/storageAccounts', last(split(parameters('storageAccountResourceId'), '/'))), '2021-04-01').keys[0].value)), createObject('name', 'WEBSITE_CONTENTSHARE', 'value', toLower(parameters('functionAppName'))), createObject('name', 'FUNCTIONS_EXTENSION_VERSION', 'value', '~4'), createObject('name', 'FUNCTIONS_WORKER_RUNTIME', 'value', variables('functionsWorkerRuntime'))), if(parameters('enableApplicationInsights'), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference('applicationInsights').ConnectionString)), createArray()), variables('isolatedAppSettings'), variables('windowsAppSettings')))), 'linuxFxVersion', if(contains(parameters('functionAppKind'), 'linux'), format('{0}|{1}', variables('linuxRuntimeStack'), variables('decimalRuntimeVersion')), null()), 'netFrameworkVersion', if(and(not(contains(parameters('functionAppKind'), 'linux')), contains(parameters('runtimeStack'), 'dotnet')), format('v{0}', variables('decimalRuntimeVersion')), null())), variables('siteConfigNetworkRestrictions')))]",
                "virtualNetworkSubnetId": "[if(not(empty(parameters('functionAppOutboundSubnetId'))), parameters('functionAppOutboundSubnetId'), null())]",
                "vnetImagePullEnabled": "[if(or(equals(parameters('hostingPlanType'), 'FlexConsumption'), equals(parameters('hostingPlanType'), 'Consumption')), null(), if(not(empty(parameters('functionAppOutboundSubnetId'))), true(), false()))]",
                "vnetContentShareEnabled": "[if(empty(parameters('fileShareName')), null(), if(not(empty(parameters('functionAppOutboundSubnetId'))), true(), false()))]",
                "vnetRouteAllEnabled": "[if(or(equals(parameters('hostingPlanType'), 'FlexConsumption'), equals(parameters('hostingPlanType'), 'Consumption')), null(), if(not(empty(parameters('functionAppOutboundSubnetId'))), true(), false()))]"
              },
              "dependsOn": [
                "applicationInsights",
                "storageAccount"
              ]
            },
            "functionApp_PrivateEndpoint": {
              "condition": "[parameters('enableInboundPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "properties": {
                "customNetworkInterfaceName": "[variables('privateEndpointNICName')]",
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('functionAppInboundSubnetId')]"
                }
              },
              "tags": "[coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject())]",
              "dependsOn": [
                "functionApp"
              ]
            },
            "functionApp_PrivateDnsZoneGroup": {
              "condition": "[and(parameters('enableInboundPrivateEndpoint'), not(empty(parameters('functionAppPrivateDnsZoneId'))))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-06-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), variables('privateEndpointName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[if(not(empty(parameters('functionAppPrivateDnsZoneId'))), format('{0}-config', last(split(parameters('functionAppPrivateDnsZoneId'), '/'))), '')]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('functionAppPrivateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "functionApp_PrivateEndpoint"
              ]
            },
            "functionApp_diagnosticsSettings": {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('functionAppName'))]",
              "name": "[format('{0}-diagnosticSettings', parameters('functionAppName'))]",
              "properties": {
                "logs": [
                  {
                    "category": "FunctionAppLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]"
              },
              "dependsOn": [
                "functionApp"
              ]
            },
            "updatePrivateLinkScope": {
              "condition": "[and(parameters('enableApplicationInsights'), not(empty(parameters('privateLinkScopeResourceId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('PrivateLinkScope-{0}', uniqueString(deployment().name, parameters('location')))]",
              "subscriptionId": "[subscription().subscriptionId]",
              "location": "[resourceGroup().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "privateLinkScopeResourceId": {
                    "value": "[parameters('privateLinkScopeResourceId')]"
                  },
                  "scopedResourceIds": {
                    "value": [
                      "[resourceId('Microsoft.Insights/components', format('{0}-insights', parameters('functionAppName')))]"
                    ]
                  },
                  "location": "[if(empty(parameters('privateLinkScopeResourceId')), createObject('value', ''), createObject('value', reference('privateLinkScope', '2020-11-01', 'full').location))]"
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.31.92.45157",
                      "templateHash": "6283139299835234071"
                    }
                  },
                  "parameters": {
                    "privateLinkScopeResourceId": {
                      "type": "string"
                    },
                    "scopedResourceIds": {
                      "type": "array"
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('addScopedResources-{0}', uniqueString(deployment().name, parameters('location')))]",
                      "subscriptionId": "[split(parameters('privateLinkScopeResourceId'), '/')[2]]",
                      "resourceGroup": "[split(parameters('privateLinkScopeResourceId'), '/')[4]]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "privateLinkScopeResourceId": {
                            "value": "[parameters('privateLinkScopeResourceId')]"
                          },
                          "scopedResourceIds": {
                            "value": "[parameters('scopedResourceIds')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.31.92.45157",
                              "templateHash": "7172663132659946173"
                            }
                          },
                          "parameters": {
                            "scopedResourceIds": {
                              "type": "array"
                            },
                            "privateLinkScopeResourceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "scopedResources",
                                "count": "[length(parameters('scopedResourceIds'))]"
                              },
                              "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                              "apiVersion": "2021-07-01-preview",
                              "name": "[format('{0}/{1}', last(split(parameters('privateLinkScopeResourceId'), '/')), last(split(parameters('scopedResourceIds')[copyIndex()], '/')))]",
                              "properties": {
                                "linkedResourceId": "[parameters('scopedResourceIds')[copyIndex()]]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "applicationInsights",
                "privateLinkScope"
              ]
            },
            "storageBlobDataOwnerRoleAssignment": {
              "condition": "[or(empty(parameters('fileShareName')), equals(parameters('hostingPlanType'), 'FlexConsumption'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "roleAssignment-storageAccount",
              "subscriptionId": "[split(parameters('storageAccountResourceId'), '/')[2]]",
              "resourceGroup": "[split(parameters('storageAccountResourceId'), '/')[4]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "principalId": {
                    "value": "[reference('functionApp', '2023-12-01', 'full').identity.principalId]"
                  },
                  "storageAccountResourceId": {
                    "value": "[parameters('storageAccountResourceId')]"
                  },
                  "roleDefinitionId": {
                    "value": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.31.92.45157",
                      "templateHash": "14352523563939232109"
                    }
                  },
                  "parameters": {
                    "principalId": {
                      "type": "string"
                    },
                    "storageAccountResourceId": {
                      "type": "string"
                    },
                    "roleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountResourceId'), '/')))]",
                      "name": "[guid(parameters('principalId'), parameters('roleDefinitionId'), parameters('storageAccountResourceId'))]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                        "principalId": "[parameters('principalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "functionApp"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameHostingPlan')), 'Microsoft.Resources/deployments', format('hostingPlan-{0}', uniqueString(deployment().name, parameters('location'))))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameNetworking')), 'Microsoft.Resources/deployments', format('networking-resources-{0}}}', uniqueString(deployment().name, parameters('location'))))]",
        "rgs",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupNameStorage')), 'Microsoft.Resources/deployments', format('storage-resources-{0}', uniqueString(deployment().name, parameters('location'))))]"
      ]
    }
  ]
}